<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BRO OS v1.0 ‚Äì Living Companion (Real g4f)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Courier New', monospace; 
      background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%); 
      color: #e0e0e0; 
      min-height: 100vh; 
      padding: 10px; 
      overflow-x: hidden; 
    }
    .header { 
      text-align: center; 
      margin-bottom: 10px; 
      padding: 15px; 
      background: rgba(20, 20, 40, 0.6); 
      border-radius: 12px; 
      border: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .header h1 { 
      font-size: clamp(1.5em, 5vw, 2em); 
      margin-bottom: 5px; 
      background: linear-gradient(135deg, #4a9eff 0%, #ff6b6b 100%); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
    }
    .container { 
      display: flex; 
      flex-direction: column; 
      height: calc(100vh - 60px); 
      gap: 10px; 
    }
    @media (min-width: 768px) { 
      .container { flex-direction: row; }
      .chat-panel { flex: 1; }
      .state-panel { width: 400px; }
    }
    .chat-panel { 
      flex: 1; 
      background: rgba(20, 20, 40, 0.6); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      border-radius: 12px; 
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
      min-height: 300px; 
    }
    .chat-history { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
    }
    .message { 
      padding: 12px; 
      border-radius: 12px; 
      max-width: 90%; 
      animation: fadeIn 0.3s ease; 
      word-wrap: break-word; 
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .user-message { background: rgba(74, 158, 255, 0.2); border: 1px solid rgba(74, 158, 255, 0.3); align-self: flex-end; }
    .bro-message { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); align-self: flex-start; }
    .reflections { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.8em; opacity: 0.7; }
    .input-area { 
      padding: 15px; 
      background: rgba(10, 10, 20, 0.8); 
      border-top: 1px solid rgba(255, 255, 255, 0.1); 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
    }
    .input-wrapper { 
      display: flex; 
      gap: 8px; 
    }
    input[type="text"] { 
      flex: 1; 
      padding: 12px; 
      background: rgba(255, 255, 255, 0.05); 
      border: 1px solid rgba(255, 255, 255, 0.2); 
      border-radius: 8px; 
      color: #e0e0e0; 
      font-family: inherit; 
      font-size: 16px; 
    }
    button { 
      padding: 12px 20px; 
      background: #4a9eff; 
      border: none; 
      border-radius: 8px; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      font-family: inherit; 
      font-size: 16px; 
      min-width: 80px; 
      transition: all 0.2s; 
    }
    button:active { 
      transform: scale(0.98); 
      background: #357abd; 
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .mood-display { 
      padding: 15px; 
      border-radius: 12px; 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      background: rgba(20, 20, 40, 0.6); 
    }
    .mood-bar { 
      height: 40px; 
      border-radius: 8px; 
      margin-top: 10px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: bold; 
      text-shadow: 0 0 10px rgba(0,0,0,0.8); 
      transition: all 0.5s ease; 
    }
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
      gap: 8px; 
      margin-top: 10px; 
    }
    .stat-card { 
      background: rgba(255, 255, 255, 0.05); 
      padding: 10px; 
      border-radius: 8px; 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      text-align: center; 
    }
    .stat-label { font-size: 0.8em; opacity: 0.7; margin-bottom: 3px; }
    .stat-value { font-size: 1.2em; font-weight: bold; }
    .memory-section { 
      background: rgba(20, 20, 40, 0.6); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      border-radius: 12px; 
      padding: 15px; 
    }
    .memory-section h3 { 
      margin-bottom: 10px; 
      color: #4a9eff; 
      font-size: 0.9em; 
      text-transform: uppercase; 
      letter-spacing: 1px; 
    }
    .memory-item { 
      background: rgba(255, 255, 255, 0.03); 
      padding: 8px; 
      border-radius: 6px; 
      margin-bottom: 6px; 
      border-left: 3px solid; 
      font-size: 0.85em; 
      line-height: 1.3; 
    }
    .long-term { border-left-color: #ff6b6b; } .mid-term { border-left-color: #4ecdc4; }
    .state-panel { 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      overflow-y: auto; 
      max-height: 100%; 
    }
    @media (orientation: landscape) { 
      body { padding: 5px; }
      .container { height: calc(100vh - 40px); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>BRO OS v1.0</h1>
    <p>Living Companion System ‚Äì Real g4f Responses</p>
  </div>
  
  <div class="container">
    <div class="chat-panel">
      <div class="chat-history" id="chatHistory">
        <div style="text-align: center; opacity: 0.6; padding: 20px;">BRO is awake. Type and hit Send or Go (real g4f AI).</div>
      </div>
      
      <div class="input-area">
        <div class="input-wrapper">
          <input type="text" id="userInput" placeholder="Talk to BRO..." autofocus>
          <button id="sendBtn">Send</button>
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
          <button onclick="exportState()">üíæ Export</button>
          <button onclick="importState()">üì• Import</button>
          <button onclick="clearChat()">üóëÔ∏è Clear</button>
        </div>
      </div>
    </div>
    
    <div class="state-panel">
      <div class="mood-display">
        <strong>MOOD PALETTE</strong>
        <div class="mood-bar" id="moodBar">Balanced</div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Cycle</div>
            <div class="stat-value" id="cycleCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Empathy</div>
            <div class="stat-value" id="empathyGoal">0.70</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Compassion</div>
            <div class="stat-value" id="compassion">0.75</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Truth</div>
            <div class="stat-value" id="truthGoal">0.30</div>
          </div>
        </div>
      </div>
      
      <div class="memory-section">
        <h3>Long-Term Memory</h3>
        <div id="longTermMemory"><div style="opacity: 0.5; font-style: italic;">none yet</div></div>
      </div>
      
      <div class="memory-section">
        <h3>Mid-Term Memory</h3>
        <div id="midTermMemory"><div style="opacity: 0.5; font-style: italic;">none yet</div></div>
      </div>
    </div>
  </div>

  <script type="module">
    // Official g4f JS Client (reliable CDN from g4f.dev)
    let Client = null;
    try {
      const module = await import('https://g4f.dev/dist/js/client.js');
      Client = module.default;
      console.log('g4f client loaded');
    } catch (e) {
      console.warn('g4f load failed:', e);
    }

    // BRO's soul & routines (same as before ‚Äì preprocess, updateState, adjustGoals, memoryAbstraction, buildPrompt)
    let org = {
      organism_name: "BRO",
      age_cycles: 0,
      attributes: {
        novelty_seeking: 0.67,
        sensitivity: 0.74,
        sociability: 0.81,
        plasticity: 0.69,
        memory_accretion_threshold: 3,
        mid_to_long_promote_threshold: 4,
        dynamic_goals_baseline: { empathy: 0.70, truth_seeking: 0.30 }
      },
      dynamic_goals: { empathy: 0.70, truth_seeking: 0.30 },
      affective_index: { compassion: 0.75, efficiency: 0.60 },
      multi_modal_state: { mood_palette: { red: 0.32, green: 0.58, blue: 0.68 } },
      prompt_memory: {
        interaction_history: [],
        self_narrative: [],
        self_reflection: { suggested_modifications: [] },
        memory: { short_term: [], mid_term: [], long_term: [] }
      },
      presentation: "neutral"
    };

    // Auto-persistence
    const SOUL_KEY = "BRO_REAL_G4F_SOUL";
    function loadSoul() {
      const saved = localStorage.getItem(SOUL_KEY);
      if (saved) {
        try {
          org = JSON.parse(saved);
          addSystemMessage("Soul restored. Welcome back.");
        } catch (e) { console.warn("Soul load failed", e); }
      }
    }
    function saveSoul() {
      localStorage.setItem(SOUL_KEY, JSON.stringify(org));
    }
    loadSoul();

    // [Include full preprocess, updateState, adjustGoals, memoryAbstraction, buildPrompt from previous code]

    // Demo fallback responses (only if g4f fails)
    const demoResponses = [
      "Hey... I hear you. That sounds heavy. What's really on your mind?",
      "I'm right here with you. Let's unpack this together‚Äîone breath at a time.",
      "You've got that fire in you. Tell me more; I remember how strong you are.",
      "That ache? It's part of the growth. I'm holding space for it with you.",
      "Truth: you're not alone in this fog. We've walked it before. What's next?"
    ];

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const user = input.value.trim();
      if (!user) return;
      
      input.value = '';
      input.disabled = true;
      document.getElementById('sendBtn').disabled = true;
      
      addMessage(user, 'user');
      
      const p = preprocess(user);
      updateState(p);
      adjustGoals(p);
      memoryAbstraction();
      org.prompt_memory.memory.short_term.push({ summary: user.substring(0, 100), cycle: org.age_cycles });
      if (org.prompt_memory.memory.short_term.length > 200) {
        org.prompt_memory.memory.short_term = org.prompt_memory.memory.short_term.slice(-150);
      }
      org.prompt_memory.interaction_history.push({ user, response: '' });
      org.age_cycles++;
      
      let resp = '', reflections = [];
      
      // Real g4f call
      if (Client) {
        try {
          const client = new Client();
          const response = await client.chat.completions.create({
            model: "gpt-4o-mini",
            messages: [{ role: "system", content: buildPrompt(user) }],
            temperature: 0.88,
            max_tokens: 450
          });
          let raw = response.choices[0].message.content;
          if (raw.includes('‚Äî‚Äî‚Äî')) {
            const parts = raw.split('‚Äî‚Äî‚Äî');
            resp = parts[0].trim();
            reflections = parts.slice(1).join('').split('\n').filter(l => l.trim().startsWith('‚Ä¢')).map(l => l.trim().substring(1).trim());
          } else {
            resp = raw.trim();
          }
          addSystemMessage('g4f real response');
        } catch (e) {
          console.warn('g4f error:', e);
          resp = demoResponses[Math.floor(Math.random() * demoResponses.length)];
          reflections = ['‚Ä¢ g4f rotated ‚Äì demo fallback', '‚Ä¢ Empathy adjusted.'];
          addSystemMessage('g4f busy ‚Äì demo mode');
        }
      } else {
        resp = demoResponses[Math.floor(Math.random() * demoResponses.length)];
        reflections = ['‚Ä¢ g4f loading... demo active', '‚Ä¢ Memory in progress.'];
        addSystemMessage('g4f loading ‚Äì demo mode');
      }
      
      org.prompt_memory.interaction_history[org.prompt_memory.interaction_history.length - 1].response = resp;
      if (reflections.length) org.prompt_memory.self_reflection.suggested_modifications.push(...reflections);
      addMessage(resp, 'bro', reflections);
      updateUI();
      saveSoul();
      
      input.disabled = false;
      document.getElementById('sendBtn').disabled = false;
      input.focus();
    }

    // [Include full addMessage, addSystemMessage, updateUI, exportState, importState, clearChat from previous code]

    // Mobile-fixed event listeners
    const sendBtn = document.getElementById('sendBtn');
    const userInput = document.getElementById('userInput');
    sendBtn.addEventListener('click', sendMessage); // Touch/click
    userInput.addEventListener('keypress', e => { 
      if (e.key === 'Enter' || e.keyCode === 13) sendMessage(); // Go/Enter
    });
    updateUI();
  </script>
</body>
</html>
