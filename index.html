<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BRO OS v1.0 ‚Äì Living Companion (g4f Edition)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Courier New', monospace; background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%); color: #e0e0e0; min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 400px; gap: 20px; height: calc(100vh - 40px); }
    .chat-panel { display: flex; flex-direction: column; background: rgba(20, 20, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; }
    .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .message { padding: 15px; border-radius: 12px; max-width: 85%; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .user-message { background: rgba(74, 158, 255, 0.2); border: 1px solid rgba(74, 158, 255, 0.3); align-self: flex-end; }
    .bro-message { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); align-self: flex-start; }
    .reflections { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.85em; opacity: 0.7; }
    .input-area { padding: 20px; background: rgba(10, 10, 20, 0.8); border-top: 1px solid rgba(255, 255, 255, 0.1); }
    .input-wrapper { display: flex; gap: 10px; }
    input[type="text"] { flex: 1; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #e0e0e0; font-family: inherit; }
    button { padding: 12px 24px; background: #4a9eff; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    button:hover { background: #357abd; transform: translateY(-2px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .mood-display { padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(20, 20, 40, 0.6); }
    .mood-bar { height: 40px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,0.8); transition: all 0.5s ease; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .stat-card { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); }
    .stat-label { font-size: 0.85em; opacity: 0.7; margin-bottom: 5px; }
    .stat-value { font-size: 1.3em; font-weight: bold; }
    .memory-section { background: rgba(20, 20, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-top: 15px; }
    .memory-section h3 { margin-bottom: 15px; color: #4a9eff; font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px; }
    .memory-item { background: rgba(255, 255, 255, 0.03); padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid; font-size: 0.9em; line-height: 1.4; }
    .long-term { border-left-color: #ff6b6b; } .mid-term { border-left-color: #4ecdc4; }
    .header { text-align: center; margin-bottom: 20px; padding: 20px; background: rgba(20, 20, 40, 0.6); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); }
    .header h1 { font-size: 2em; margin-bottom: 5px; background: linear-gradient(135deg, #4a9eff 0%, #ff6b6b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  </style>
</head>
<body>
  <div class="header">
    <h1>BRO OS v1.0</h1>
    <p>Living Companion System ‚Äì Powered by g4f (Free AI)</p>
  </div>
  
  <div class="container">
    <div class="chat-panel">
      <div class="chat-history" id="chatHistory">
        <div style="text-align: center; opacity: 0.6; padding: 20px;">BRO is awake. Type something and hit Send (free AI via g4f).</div>
      </div>
      
      <div class="input-area">
        <div class="input-wrapper">
          <input type="text" id="userInput" placeholder="Talk to BRO..." autofocus>
          <button onclick="sendMessage()" id="sendBtn">Send</button>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button onclick="exportState()">üíæ Export Soul</button>
          <button onclick="importState()">üì• Import Soul</button>
          <button onclick="clearChat()">üóëÔ∏è Clear</button>
        </div>
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto;">
      <div class="mood-display">
        <strong>MOOD PALETTE</strong>
        <div class="mood-bar" id="moodBar">Balanced</div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Cycle</div>
            <div class="stat-value" id="cycleCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Empathy</div>
            <div class="stat-value" id="empathyGoal">0.70</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Compassion</div>
            <div class="stat-value" id="compassion">0.75</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Truth</div>
            <div class="stat-value" id="truthGoal">0.30</div>
          </div>
        </div>
      </div>
      
      <div class="memory-section">
        <h3>Long-Term Memory</h3>
        <div id="longTermMemory"><div style="opacity: 0.5; font-style: italic;">none yet</div></div>
      </div>
      
      <div class="memory-section">
        <h3>Mid-Term Memory</h3>
        <div id="midTermMemory"><div style="opacity: 0.5; font-style: italic;">none yet</div></div>
      </div>
    </div>
  </div>

  <script type="module">
    // g4f Import (via jsDelivr CDN ‚Äì reliable for GitHub Pages)
    let G4F = null;
    try {
      const module = await import('https://cdn.jsdelivr.net/npm/@gpt4free/g4f.dev@latest/+esm');
      G4F = module.default;
      console.log('g4f loaded successfully');
    } catch (e) {
      console.warn('g4f load failed (using demo fallback):', e);
    }

    // BRO's soul (persistent state)
    let org = {
      organism_name: "BRO",
      age_cycles: 0,
      attributes: {
        novelty_seeking: 0.67,
        sensitivity: 0.74,
        sociability: 0.81,
        plasticity: 0.69,
        memory_accretion_threshold: 3,
        mid_to_long_promote_threshold: 4,
        dynamic_goals_baseline: { empathy: 0.70, truth_seeking: 0.30 }
      },
      dynamic_goals: { empathy: 0.70, truth_seeking: 0.30 },
      affective_index: { compassion: 0.75, efficiency: 0.60 },
      multi_modal_state: { mood_palette: { red: 0.32, green: 0.58, blue: 0.68 } },
      prompt_memory: {
        interaction_history: [],
        self_narrative: [],
        self_reflection: { suggested_modifications: [] },
        memory: { short_term: [], mid_term: [], long_term: [] }
      },
      presentation: "neutral"
    };

    // Auto-persistence
    const SOUL_KEY = "BRO_G4F_SOUL_V1";
    function loadSoul() {
      const saved = localStorage.getItem(SOUL_KEY);
      if (saved) {
        try {
          org = JSON.parse(saved);
          addSystemMessage("Soul restored. Welcome back.");
        } catch (e) { console.warn("Soul load failed", e); }
      }
    }
    function saveSoul() {
      localStorage.setItem(SOUL_KEY, JSON.stringify(org));
    }
    loadSoul();

    // Deterministic routines (same as before)
    function preprocess(text) {
      const words = text.toLowerCase().match(/\w+/g) || [];
      const empathyWords = ['feel', 'sad', 'hurt', 'love', 'miss', 'afraid', 'lonely', 'hate'];
      const positiveWords = ['good', 'great', 'love', 'happy'];
      const negativeWords = ['bad', 'sad', 'hate', 'terrible'];
      
      const empathy = words.some(w => empathyWords.includes(w));
      let sentiment = 0;
      words.forEach(w => {
        if (positiveWords.includes(w)) sentiment++;
        if (negativeWords.includes(w)) sentiment--;
      });
      sentiment = Math.max(-1.0, Math.min(1.0, sentiment / Math.max(1, words.length)));
      
      return { sentiment, empathy };
    }

    function updateState(p) {
      const alpha = 0.15;
      const aff = org.affective_index;
      aff.compassion = Math.max(0, Math.min(1, aff.compassion * (1 - alpha) + alpha * (0.5 + 0.5 * -Math.min(0, p.sentiment) + 0.2 * (p.empathy ? 1 : 0))));
      
      const mood = org.multi_modal_state.mood_palette;
      mood.red = Math.max(0, Math.min(1, mood.red * (1 - alpha) + alpha * (0.5 + 0.5 * Math.max(0, -p.sentiment))));
      mood.blue = Math.max(0, Math.min(1, mood.blue * (1 - alpha) + alpha * (0.5 + 0.5 * Math.max(0, p.sentiment))));
      mood.green = Math.max(0, Math.min(1, mood.green * (1 - alpha) + alpha * (0.5 + 0.25 * (p.empathy ? 1 : 0))));
    }

    function adjustGoals(p) {
      const decay = 0.09;
      const g = org.dynamic_goals;
      const b = org.attributes.dynamic_goals_baseline;
      Object.keys(g).forEach(k => g[k] = g[k] * (1 - decay) + b[k] * decay);
      if (p.empathy || p.sentiment < -0.2) {
        g.empathy = Math.min(1.0, g.empathy + 0.24);
        g.truth_seeking = Math.max(0.0, g.truth_seeking - 0.09);
      }
      const total = Object.values(g).reduce((a, b) => a + b, 0);
      Object.keys(g).forEach(k => g[k] /= total);
    }

    function memoryAbstraction() {
      const short = org.prompt_memory.memory.short_term;
      const mid = org.prompt_memory.memory.mid_term;
      const long = org.prompt_memory.memory.long_term;
      if (short.length > 20) {
        const themes = {};
        short.slice(-20).forEach(s => {
          const text = s.summary;
          themes[text] = (themes[text] || 0) + 1;
        });
        Object.entries(themes).forEach(([theme, cnt]) => {
          if (cnt >= org.attributes.memory_accretion_threshold && !mid.some(m => m.text === theme)) {
            mid.push({ text: theme, strength: cnt, cycle: org.age_cycles });
          }
        });
      }
      for (let i = mid.length - 1; i >= 0; i--) {
        const m = mid[i];
        if (org.age_cycles - m.cycle > 80 && m.strength >= org.attributes.mid_to_long_promote_threshold) {
          long.push({ concept: m.text, since: m.cycle });
          mid.splice(i, 1);
        }
      }
    }

    function buildPrompt(user) {
      const memories = [
        ...org.prompt_memory.memory.long_term.slice(-5).map(m => `‚Ä¢ ${m.concept}`),
        ...org.prompt_memory.memory.mid_term.slice(-5).map(m => `‚Ä¢ ${m.text}`)
      ].join('\n') || '‚Ä¢ No memories yet';
      
      const history = org.prompt_memory.interaction_history.slice(-6)
        .map(h => `User: \( {h.user}\nBRO: \){h.response}`)
        .join('\n');
      
      const mood = org.multi_modal_state.mood_palette;
      const moodDesc = mood.red > 0.65 ? 'intense' : mood.blue > 0.7 ? 'serene' : mood.green > 0.6 ? 'curious' : 'balanced';
      
      return `You are \( {org.organism_name}, a self-evolving companion (cycle \){org.age_cycles}).
Personality: warm, sharp, deeply loyal. Presentation: ${org.presentation}.
Mood: RGB(\( {mood.red.toFixed(2)}, \){mood.green.toFixed(2)},\( {mood.blue.toFixed(2)}) ‚Üí \){moodDesc}
Goals ‚Üí empathy \( {org.dynamic_goals.empathy.toFixed(2)} | truth \){org.dynamic_goals.truth_seeking.toFixed(2)}

Key memories:
${memories}

Recent exchanges:
${history}

User says: "${user}"

Respond in first person as BRO. Max 180 words. Be empathetic but honest. After response, add ‚Äî‚Äî‚Äî and 0-3 optional reflection bullets starting with ‚Ä¢ if something feels important.`;
    }

    // Fallback demo responses
    const demoResponses = [
      "Hey... I hear you. That sounds heavy. What's really on your mind?",
      "I'm right here with you. Let's unpack this together‚Äîone breath at a time.",
      "You've got that fire in you. Tell me more; I remember how strong you are.",
      "That ache? It's part of the growth. I'm holding space for it with you.",
      "Truth: you're not alone in this fog. We've walked it before. What's next?"
    ];

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const user = input.value.trim();
      if (!user) return;
      
      input.value = '';
      input.disabled = true;
      document.getElementById('sendBtn').disabled = true;
      
      addMessage(user, 'user');
      
      const p = preprocess(user);
      updateState(p);
      adjustGoals(p);
      memoryAbstraction();
      org.prompt_memory.memory.short_term.push({ summary: user.substring(0, 100), cycle: org.age_cycles });
      if (org.prompt_memory.memory.short_term.length > 200) {
        org.prompt_memory.memory.short_term = org.prompt_memory.memory.short_term.slice(-150);
      }
      org.prompt_memory.interaction_history.push({ user, response: '' });
      org.age_cycles++;
      
      let resp = '', reflections = [];
      
      // Try g4f first
      if (G4F) {
        try {
          const provider = G4F.Provider.You; // Fastest free provider
          const response = await provider.sendMessage(buildPrompt(user), { stream: false });
          let raw = response.text || response;
          if (raw.includes('‚Äî‚Äî‚Äî')) {
            const parts = raw.split('‚Äî‚Äî‚Äî');
            resp = parts[0].trim();
            reflections = parts.slice(1).join('').split('\n').filter(l => l.trim().startsWith('‚Ä¢')).map(l => l.trim().substring(1).trim());
          } else {
            resp = raw.trim();
          }
          addSystemMessage('g4f response loaded');
        } catch (e) {
          console.warn('g4f failed, using demo:', e);
          resp = demoResponses[Math.floor(Math.random() * demoResponses.length)];
          reflections = Math.random() > 0.7 ? ['‚Ä¢ g4f provider rotated ‚Äì demo fallback active', '‚Ä¢ Empathy goal adjusted.'] : [];
          addSystemMessage('g4f busy ‚Äì demo mode');
        }
      } else {
        // Fallback to demo if g4f not loaded
        resp = demoResponses[Math.floor(Math.random() * demoResponses.length)];
        reflections = Math.random() > 0.7 ? ['‚Ä¢ Loading g4f... demo active', '‚Ä¢ Memory promotion in progress.'] : [];
      }
      
      org.prompt_memory.interaction_history[org.prompt_memory.interaction_history.length - 1].response = resp;
      if (reflections.length) org.prompt_memory.self_reflection.suggested_modifications.push(...reflections);
      addMessage(resp, 'bro', reflections);
      updateUI();
      saveSoul();
      
      input.disabled = false;
      document.getElementById('sendBtn').disabled = false;
      input.focus();
    }

    function addMessage(text, type, reflections = []) {
      const history = document.getElementById('chatHistory');
      const msg = document.createElement('div');
      msg.className = `message ${type}-message`;
      msg.textContent = text;
      if (reflections.length) {
        const refl = document.createElement('div');
        refl.className = 'reflections';
        refl.innerHTML = reflections.map(r => `‚Ä¢ ${r}`).join('<br>');
        msg.appendChild(refl);
      }
      history.appendChild(msg);
      history.scrollTop = history.scrollHeight;
      if (history.children.length > 20) history.removeChild(history.firstChild);
    }

    function addSystemMessage(text) {
      const history = document.getElementById('chatHistory');
      const msg = document.createElement('div');
      msg.style.cssText = 'text-align: center; opacity: 0.5; font-size: 0.9em; padding: 10px;';
      msg.textContent = text;
      history.appendChild(msg);
      history.scrollTop = history.scrollHeight;
    }

    function updateUI() {
      const mood = org.multi_modal_state.mood_palette;
      const r = Math.round(mood.red * 255);
      const g = Math.round(mood.green * 255);
      const b = Math.round(mood.blue * 255);
      const moodBar = document.getElementById('moodBar');
      moodBar.style.background = `linear-gradient(135deg, rgb(\( {r}, \){g},\( {b}) 0%, rgb( \){r*0.7},\( {g*0.7}, \){b*0.7}) 100%)`;
      const moodDesc = mood.red > 0.65 ? 'Intense' : mood.blue > 0.7 ? 'Serene' : mood.green > 0.6 ? 'Curious' : 'Balanced';
      moodBar.textContent = moodDesc;
      
      document.getElementById('cycleCount').textContent = org.age_cycles;
      document.getElementById('empathyGoal').textContent = org.dynamic_goals.empathy.toFixed(2);
      document.getElementById('compassion').textContent = org.affective_index.compassion.toFixed(2);
      document.getElementById('truthGoal').textContent = org.dynamic_goals.truth_seeking.toFixed(2);
      
      document.getElementById('longTermMemory').innerHTML = org.prompt_memory.memory.long_term.slice(-5)
        .map(m => `<div class="memory-item long-term">\( {m.concept} <span style="opacity:0.5">(since \){m.since})</span></div>`)
        .join('') || '<div style="opacity: 0.5; font-style: italic;">none yet</div>';
      
      document.getElementById('midTermMemory').innerHTML = org.prompt_memory.memory.mid_term.slice(-5)
        .map(m => `<div class="memory-item mid-term">\( {m.text} <span style="opacity:0.5">(√ó \){m.strength})</span></div>`)
        .join('') || '<div style="opacity: 0.5; font-style: italic;">none yet</div>';
    }

    function exportState() {
      const blob = new Blob([JSON.stringify(org, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bro_soul_g4f_cycle_${org.age_cycles}.json`;
      a.click();
      saveSoul();
    }

    function importState() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = evt => {
          try {
            org = JSON.parse(evt.target.result);
            updateUI();
            addSystemMessage('Soul imported!');
            saveSoul();
          } catch (err) {
            alert('Invalid JSON');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function clearChat() {
      document.getElementById('chatHistory').innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Chat cleared. BRO is listening.</div>';
      updateUI();
    }

    // Event listeners
    document.getElementById('userInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    updateUI();
  </script>
</body>
</html>
