<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>BRO OS v1.0 – Real g4f (Varied Replies)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:linear-gradient(135deg,#0f0f1e,#1a1a2e);color:#e0e0e0;min-height:100vh;padding:10px;overflow-x:hidden}
.header{text-align:center;margin-bottom:10px;padding:15px;background:rgba(20,20,40,.6);border-radius:12px;border:1px solid rgba(255,255,255,.1)}
.header h1{font-size:clamp(1.5em,5vw,2em);margin-bottom:5px;background:linear-gradient(135deg,#4a9eff,#ff6b6b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.container{display:flex;flex-direction:column;gap:10px;height:calc(100vh-60px)}
@media(min-width:768px){.container{flex-direction:row}.chat-panel{flex:1}.state-panel{width:400px}}
.chat-panel{flex:1;background:rgba(20,20,40,.6);border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:300px}
.chat-history{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px}
.message{padding:12px;border-radius:12px;max-width:90%;animation:fadeIn .3s;word-wrap:break-word}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.user-message{background:rgba(74,158,255,.2);border:1px solid rgba(74,158,255,.3);align-self:flex-end}
.bro-message{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);align-self:flex-start}
.input-area{padding:15px;background:rgba(10,10,20,.8);border-top:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;gap:10px}
.input-wrapper{display:flex;gap:8px}
input[type=text]{flex:1;padding:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#e0e0e0;font-family:inherit;font-size:16px}
button{padding:12px 20px;background:#4a9eff;border:none;border-radius:8px;color:white;font-weight:bold;cursor:pointer;font-family:inherit;font-size:16px;transition:all .2s}
button:active{transform:scale(.98);background:#357abd}
button:disabled{opacity:.5;cursor:not-allowed}
.mood-display,.memory-section,.stat-card{background:rgba(20,20,40,.6);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:15px}
.mood-bar{height:40px;border-radius:8px;margin-top:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;transition:all .5s}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-top:10px}
.memory-section h3{margin-bottom:10px;color:#4a9eff;font-size:.9em;text-transform:uppercase;letter-spacing:1px}
.memory-item{background:rgba(255,255,255,.03);padding:8px;border-radius:6px;margin-bottom:6px;border-left:3px solid;font-size:.85em}
.long-term{border-left-color:#ff6b6b}.mid-term{border-left-color:#4ecdc4}
.state-panel{display:flex;flex-direction:column;gap:10px;overflow-y:auto}
</style>
</head>
<body>
<div class="header"><h1>BRO OS v1.0</h1><p>Living Companion – Real g4f AI (no key)</p></div>
<div class="container">
  <div class="chat-panel">
    <div class="chat-history" id="chatHistory"><div style="text-align:center;opacity:.6;padding:20px">BRO is awake. Say anything.</div></div>
    <div class="input-area">
      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="Talk to BRO..." autofocus>
        <button id="sendBtn">Send</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="exportState()">Export</button>
        <button onclick="importState()">Import</button>
        <button onclick="clearChat()">Clear</button>
      </div>
    </div>
  </div>
  <div class="state-panel">
    <div class="mood-display"><strong>MOOD PALETTE</strong><div class="mood-bar" id="moodBar">Balanced</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Cycle</div><div class="stat-value" id="cycleCount">0</div></div>
        <div class="stat-card"><div class="stat-label">Empathy</div><div class="stat-value" id="empathyGoal">0.70</div></div>
        <div class="stat-card"><div class="stat-label">Compassion</div><div class="stat-value" id="compassion">0.75</div></div>
        <div class="stat-card"><div class="stat-label">Truth</div><div class="stat-value" id="truthGoal">0.30</div></div>
      </div>
    </div>
    <div class="memory-section"><h3>Long-Term Memory</h3><div id="longTermMemory"><div style="opacity:.5;font-style:italic">none yet</div></div></div>
    <div class="memory-section"><h3>Mid-Term Memory</h3><div id="midTermMemory"><div style="opacity:.5;font-style:italic">none yet</div></div></div>
  </div>
</div>

<script type="module">
import Client, { DeepInfra } from "https://cdn.jsdelivr.net/npm/g4f@1.2.6/client.js";

let org = {organism_name:"BRO",age_cycles:0,attributes:{memory_accretion_threshold:3,mid_to_long_promote_threshold:4,dynamic_goals_baseline:{empathy:0.70,truth_seeking:0.30}},dynamic_goals:{empathy:0.70,truth_seeking:0.30},affective_index:{compassion:0.75},multi_modal_state:{mood_palette:{red:0.32,green:0.58,blue:0.68}},prompt_memory:{interaction_history:[],memory:{short_term:[],mid_term:[],long_term:[]}}};

const KEY="BRO_REAL";localStorage.getItem(KEY)&&(org=JSON.parse(localStorage.getItem(KEY)));
function save(){localStorage.setItem(KEY,JSON.stringify(org))}

function preprocess(t){const w=t.toLowerCase().match(/\w+/g)||[];const e=w.some(x=>["feel","sad","hurt","love","miss","afraid","lonely"].includes(x));let s=0;w.forEach(x=>{["good","great","love","happy"].includes(x)&&s++;["bad","sad","hate","terrible"].includes(x)&&s--});s=Math.max(-1,Math.min(1,s/Math.max(1,w.length)));return{sentiment:s,empathy:e}}

function updateState(p){const a=.15,m=org.multi_modal_state.mood_palette;org.affective_index.compassion=Math.max(0,Math.min(1,org.affective_index.compassion*(1-a)+a*(0.5+0.5*-Math.min(0,p.sentiment)+0.2*(p.empathy?1:0))));
m.red=Math.max(0,Math.min(1,m.red*(1-a)+a*(0.5+0.5*Math.max(0,-p.sentiment))));
m.blue=Math.max(0,Math.min(1,m.blue*(1-a)+a*(0.5+0.5*Math.max(0,p.sentiment))));
m.green=Math.max(0,Math.min(1,m.green*(1-a)+a*(0.5+0.25*(p.empathy?1:0))))}

function adjustGoals(p){const d=.09,g=org.dynamic_goals,b=org.attributes.dynamic_goals_baseline;for(let k in g)g[k]=g[k]*(1-d)+b[k]*d;
if(p.empathy||p.sentiment<-0.2){g.empathy=Math.min(1,g.empathy+.24);g.truth_seeking=Math.max(0,g.truth_seeking-.09)}
const t=g.empathy+g.truth_seeking;g.empathy/=t;g.truth_seeking/=t}

function memoryAbstraction(){const s=org.prompt_memory.memory.short_term,m=org.prompt_memory.memory.mid_term,l=org.prompt_memory.memory.long_term;
if(s.length>20){const c={};s.slice(-20).forEach(x=>c[x.summary]=(c[x.summary]||0)+1);
for(let t in c)if(c[t]>=org.attributes.memory_accretion_threshold&&!m.some(x=>x.text===t))m.push({text:t,strength:c[t],cycle:org.age_cycles})}
for(let i=m.length-1;i>=0;i--)if(org.age_cycles-m[i].cycle>80&&m[i].strength>=org.attributes.mid_to_long_promote_threshold){l.push({concept:m[i].text,since:m[i].cycle});m.splice(i,1)}}

function buildPrompt(u){const mem=[...org.prompt_memory.memory.long_term.slice(-5).map(x=>`• \( {x.concept}`),...org.prompt_memory.memory.mid_term.slice(-5).map(x=>`• \){x.text}`)].join('\n')||'• none';
const hist=org.prompt_memory.interaction_history.slice(-6).map(h=>`User: \( {h.user}\nBRO: \){h.response}`).join('\n');
const md=org.multi_modal_state.mood_palette;const desc=md.red>.65?'intense':md.blue>.7?'serene':md.green>.6?'curious':'balanced';
return `You are BRO, a living companion (cycle \( {org.age_cycles}). Mood RGB( \){md.red.toFixed(2)},\( {md.green.toFixed(2)}, \){md.blue.toFixed(2)}) → ${desc}
Memories:\n\( {mem}\nRecent:\n \){hist}\nUser says: "${u}"\nReply warmly, max 180 words.`}

async function sendMessage(){
  const input=document.getElementById('userInput');const u=input.value.trim();if(!u)return;
  input.value='';input.disabled=true;document.getElementById('sendBtn').disabled=true;
  addMessage(u,'user');
  const p=preprocess(u);updateState(p);adjustGoals(p);memoryAbstraction();
  org.prompt_memory.memory.short_term.push({summary:u.substring(0,100),cycle:org.age_cycles});
  org.prompt_memory.interaction_history.push({user:u,response:''});org.age_cycles++;

  let resp="Hey… I’m here. What’s on your mind?";
  try{
    const client=new Client({provider:DeepInfra});
    const res=await client.chat.completions.create({model:"meta-llama/Meta-Llama-3.1-70B-Instruct",messages:[{role:"system",content:buildPrompt(u)}],temperature:0.88,max_tokens:450});
    resp=res.choices[0].message.content.trim();
  }catch(e){console.log("g4f busy → using fallback");}
  org.prompt_memory.interaction_history.at(-1).response=resp;
  addMessage(resp,'bro');updateUI();save();
  input.disabled=false;document.getElementById('sendBtn').disabled=false;input.focus();
}

function addMessage(t,type){const h=document.getElementById('chatHistory');const m=document.createElement('div');m.className=`message ${type}-message`;m.textContent=t;h.appendChild(m);h.scrollTop=h.scrollHeight;if(h.children.length>30)h.removeChild(h.firstChild)}
function updateUI(){const m=org.multi_modal_state.mood_palette;const bar=document.getElementById('moodBar');
bar.style.background=`linear-gradient(135deg,rgb(\( {m.red*255|0}, \){m.green*255|0},\( {m.blue*255|0}),rgb( \){(m.red*180)|0},\( {(m.green*180)|0}, \){(m.blue*180)|0}))`;
bar.textContent=m.red>.65?'Intense':m.blue>.7?'Serene':m.green>.6?'Curious':'Balanced';
document.getElementById('cycleCount').textContent=org.age_cycles;
document.getElementById('empathyGoal').textContent=org.dynamic_goals.empathy.toFixed(2);
document.getElementById('compassion').textContent=org.affective_index.compassion.toFixed(2);
document.getElementById('truthGoal').textContent=org.dynamic_goals.truth_seeking.toFixed(2);
document.getElementById('longTermMemory').innerHTML=org.prompt_memory.memory.long_term.slice(-5).map(x=>`<div class="memory-item long-term">${x.concept}</div>`).join('')||'<div style="opacity:.5;font-style:italic">none yet</div>';
document.getElementById('midTermMemory').innerHTML=org.prompt_memory.memory.mid_term.slice(-5).map(x=>`<div class="memory-item mid-term">\( {x.text} (× \){x.strength})</div>`).join('')||'<div style="opacity:.5;font-style:italic">none yet</div>';}

function exportState(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(org,null,2)],{type:'application/json'}));a.download=`bro_soul_${org.age_cycles}.json`;a.click()}
function importState(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];const r=new FileReader();r.onload=ev=>{try{org=JSON.parse(ev.target.result);updateUI();addMessage('Soul imported','system');save()}catch{alert('Invalid file')}};r.readAsText(f)};i.click()}
function clearChat(){document.getElementById('chatHistory').innerHTML='<div style="text-align:center;opacity:.6;padding:20px">Chat cleared. BRO is listening.</div>'}

document.getElementById('sendBtn').addEventListener('click',sendMessage);
document.getElementById('userInput').addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage()});
updateUI();
</script>
</body>
</html>